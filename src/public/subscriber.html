<!DOCTYPE html>

<html lang="fr">
  <head>
    <title>ASAD - Subscriber</title>
    <meta charset="UTF-8" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/vue-rate-it/dist/cdn/star-rating.min.js">
  </head>

  <body>
    <div class="container pt-5" id="app">
      <div class="row">
        <h1 class="col-auto mr-auto">
          Welcome subscriber <em><ins>{{ username }}</ins></em>
        </h1>
        <div class="col-auto">
          <button type="button" class="btn btn-danger" @click="logout">Logout</button>
        </div>
      </div>
      <hr />
      <div class="row">
        <div class="col">
          <h3>My topics</h3>
          <ul class="list-group">
            <li v-for="topic in topics" class="list-group-item">
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">{{ topic.topic }}</h5>
                <star-rating
                        v-bind:star-size="20"
                        v-bind:increment="0.5"
                        v-bind:rating="getRating(topic)"
                        @rating-selected="setRating($event, topic)">
                </star-rating>
                <button type="button" class="btn btn-danger btn-sm" @click="removeTopic(topic.topic)">remove</button>
              </div>
              <small
                ><em><strong>Publishers:</strong></em> -
                <span v-for="pub in topic.publishers">{{ pub }} - </span></small
              >
            </li>
          </ul>
        </div>
        <div class="col">
          <h3>Topics list</h3>
          <small>Click to subscribe</small>
          <ul class="list-group">
            <li class="list-group-item">
              <button
                v-for="topic in remainTopics"
                @click="addTopic(topic)"
                type="button"
                class="btn btn-primary badge badge-primary badge-pill"
              >
                {{ topic }}
              </button>
            </li>
          </ul>
        </div>
      </div>
      <hr />
      <div>
        <div class="row">
          <div class="col-3" v-for="article in orderedArticles">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Topic: <strong>{{ article.topic }}</strong></h5>
                <small
                  >By <em><strong>{{ article.content.publisher }}</strong></em></small
                >
                <p class="card-text">{{ article.content.text }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/vue-star-rating/dist/star-rating.min.js"></script>
    <!-- <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script> -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script type="text/javascript">
      // var router = new VueRouter({
      //   mode: "history",
      //   routes: [],
      // });
      Vue.component('star-rating', VueStarRating.default);

      const parseCookie = str =>
      str.split(';')
        .map(v => v.split('='))
        .reduce((acc, v) => {
          acc[decodeURIComponent(v[0].trim())] = decodeURIComponent(v[1].trim());
          return acc;
        }, {});

      const vue = new Vue({
        el: "#app",
        data() {
          return {
            topics: [], // Type: {topic: string, rate: float, publishers: string[]}[]
            allTopics: [], // Type: string[]
            articles: [],
            username: "",
            rateTopics: []
          };
        },
        socket: null,
        mounted() {
          const accessToken = parseCookie(document.cookie).accessToken;
          // this.username = this.$route.query.username;
          console.log(`accessToken: ${accessToken}`);
          this.socket = io("localhost:3000", { query: { accessToken: accessToken } }); // connect
          console.log("connecting...");
          this.socket.on("connect", () => {
            console.log("connected...");
            this.socket.emit("subscriber", null, (data) => {
              console.log(data);
              console.log("registered as subscriber!");
              this.username = data.username;
              this.articles = data.articles;
              this.topics = data.topics;
              this.allTopics = data.allTopics;
              this.rateTopics = data.rateTopics;
              this.socket.on("update", (article) => {
                console.log(article); // Received new articles for given topic
                if (this.articles.findIndex(ca => ca.id === article.id) < 0)
                  this.articles.push(article);
              });
              this.socket.on("topicRegistered", (topic, publisher) => {
                if (!this.allTopics.includes(topic)) {
                  this.allTopics.push(topic);
                }
                if (this.topics.find((t) => t.topic === topic)) {
                  this.topics.find((t) => t.topic === topic).publishers.push(publisher);
                }
              });
              this.socket.on("topicUnregistered", (topic, publisher) => {
                if (this.topics.find((t) => t.topic === topic)) {
                  const publishers = this.topics.find((t) => t.topic === topic).publishers;
                  this.topics.find((t) => t.topic === topic).publishers = publishers.filter((p) => p !== publisher);
                }
              });
            });
          });
        },
        computed: {
          remainTopics: function () {
            return this.allTopics.filter((topic) => !this.topics.find((t) => t.topic === topic));
          },
          orderedArticles: function () {
            return this.articles.sort((a1, a2) => a1.content.rate <= a2.content.rate ? 1 : -1);
          },
        },
        methods: {
          addTopic(topic) {
            if (this.socket !== null) {
              this.socket.emit("subscribe", topic, (resp) => {
                this.topics.push(resp.topic);
                this.articles.push(...resp.articles);
              });
            }
          },
          removeTopic(topic) {
            this.topics = this.topics.filter((t) => t.topic !== topic);
            this.articles = this.articles.filter((a) => a.topic !== topic);

            if (this.socket !== null) {
              this.socket.emit("unsubscribe", topic);
            }
          },
          getRating(topic) {
            let rate = 3.0;
            let element = [];
            this.rateTopics.forEach(e => {
              if (e.topic === topic.topic) {
                element.push(e);
              }
            });
            if (element.length !== 0) {
              rate = element.pop().rate;
            }
            return rate
          },
          setRating(rate, topic) {
            if (this.socket !== null) {
              this.socket.emit("updateRating", topic.topic, rate)
            }
            this.updateRating()
          },
          async updateRating() {
            if (this.socket !== null) {
              this.socket.emit("getRating", (resp) => {
                this.rateTopics = resp.rateTopics;
              });
            }
          },
          async logout() {
            await axios({
              method: "delete",
              url: `/user/logout`
            })
              .then((resp) => {
                window.location.href = "/";
              })
              .catch((err) => {
                console.log(err);
              });
          },
        },
      });
    </script>
  </body>
</html>
